{% extends "layout.html" %}

{% block title %}市场扫描 - 智能分析系统{% endblock %}

{% block content %}
<div class="page-transition">
    <!-- Enhanced Material Design 3 分析表单 -->
    <div class="md3-card md3-card-elevated md3-animate-fade-in" style="margin-bottom: 32px;">
        <div class="md3-card-header">
            <h2 class="md3-card-title">
                <i class="material-icons">search</i> 市场扫描
            </h2>
            <p class="md3-card-subtitle">智能筛选高评分投资机会</p>
        </div>
        <div class="md3-card-body">
            <form id="scan-form" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; align-items: end;">
                <div class="md3-text-field md3-text-field-outlined">
                    <select class="md3-text-field-input" id="index-selector">
                        <option value="">-- 选择指数 --</option>
                        <option value="000300">沪深300</option>
                        <option value="000905">中证500</option>
                        <option value="000852">中证1000</option>
                        <option value="000001">上证指数</option>
                    </select>
                    <label class="md3-text-field-label">选择指数</label>
                </div>
                <div class="md3-text-field md3-text-field-outlined">
                    <select class="md3-text-field-input" id="industry-selector">
                        <option value="">-- 选择行业 --</option>
                        <option value="保险">保险</option>
                        <option value="食品饮料">食品饮料</option>
                        <option value="多元金融">多元金融</option>
                        <option value="游戏">游戏</option>
                        <option value="酿酒行业">酿酒行业</option>
                        <option value="商业百货">商业百货</option>
                        <option value="证券">证券</option>
                        <option value="船舶制造">船舶制造</option>
                        <option value="家用轻工">家用轻工</option>
                        <option value="旅游酒店">旅游酒店</option>
                        <option value="美容护理">美容护理</option>
                        <option value="医疗服务">医疗服务</option>
                        <option value="软件开发">软件开发</option>
                        <option value="化学制药">化学制药</option>
                        <option value="医疗器械">医疗器械</option>
                        <option value="家电行业">家电行业</option>
                        <option value="汽车服务">汽车服务</option>
                        <option value="造纸印刷">造纸印刷</option>
                        <option value="纺织服装">纺织服装</option>
                        <option value="光伏设备">光伏设备</option>
                        <option value="房地产服务">房地产服务</option>
                        <option value="文化传媒">文化传媒</option>
                        <option value="医药商业">医药商业</option>
                        <option value="中药">中药</option>
                        <option value="专业服务">专业服务</option>
                        <option value="生物制品">生物制品</option>
                        <option value="仪器仪表">仪器仪表</option>
                        <option value="房地产开发">房地产开发</option>
                        <option value="教育">教育</option>
                        <option value="半导体">半导体</option>
                        <option value="玻璃玻纤">玻璃玻纤</option>
                        <option value="汽车整车">汽车整车</option>
                        <option value="消费电子">消费电子</option>
                        <option value="贸易行业">贸易行业</option>
                        <option value="包装材料">包装材料</option>
                        <option value="汽车零部件">汽车零部件</option>
                        <option value="电子化学品">电子化学品</option>
                        <option value="电子元件">电子元件</option>
                        <option value="装修建材">装修建材</option>
                        <option value="交运设备">交运设备</option>
                        <option value="农牧饲渔">农牧饲渔</option>
                        <option value="塑料制品">塑料制品</option>
                        <option value="珠宝首饰">珠宝首饰</option>
                        <option value="贵金属">贵金属</option>
                        <option value="非金属材料">非金属材料</option>
                        <option value="装修装饰">装修装饰</option>
                        <option value="风电设备">风电设备</option>
                        <option value="工程咨询服务">工程咨询服务</option>
                        <option value="专用设备">专用设备</option>
                        <option value="光学光电子">光学光电子</option>
                        <option value="航空机场">航空机场</option>
                        <option value="小金属">小金属</option>
                        <option value="物流行业">物流行业</option>
                        <option value="通用设备">通用设备</option>
                        <option value="计算机设备">计算机设备</option>
                        <option value="环保行业">环保行业</option>
                        <option value="航运港口">航运港口</option>
                        <option value="通信设备">通信设备</option>
                        <option value="水泥建材">水泥建材</option>
                        <option value="电池">电池</option>
                        <option value="化肥行业">化肥行业</option>
                        <option value="互联网服务">互联网服务</option>
                        <option value="工程建设">工程建设</option>
                        <option value="橡胶制品">橡胶制品</option>
                        <option value="化学原料">化学原料</option>
                        <option value="化纤行业">化纤行业</option>
                        <option value="农药兽药">农药兽药</option>
                        <option value="化学制品">化学制品</option>
                        <option value="能源金属">能源金属</option>
                        <option value="有色金属">有色金属</option>
                        <option value="采掘行业">采掘行业</option>
                        <option value="燃气">燃气</option>
                        <option value="综合行业">综合行业</option>
                        <option value="工程机械">工程机械</option>
                        <option value="银行">银行</option>
                        <option value="铁路公路">铁路公路</option>
                        <option value="石油行业">石油行业</option>
                        <option value="公用事业">公用事业</option>
                        <option value="电机">电机</option>
                        <option value="通信服务">通信服务</option>
                        <option value="钢铁行业">钢铁行业</option>
                        <option value="电力行业">电力行业</option>
                        <option value="电网设备">电网设备</option>
                        <option value="煤炭行业">煤炭行业</option>
                        <option value="电源设备">电源设备</option>
                        <option value="航天航空">航天航空</option>
                    </select>
                    <label class="md3-text-field-label">选择行业</label>
                </div>

                <div class="md3-text-field md3-text-field-outlined">
                    <input type="text" class="md3-text-field-input" id="custom-stocks" placeholder=" ">
                    <label class="md3-text-field-label">自定义股票</label>
                    <div class="md3-text-field-supporting-text">多个股票代码用逗号分隔</div>
                </div>

                <div style="display: flex; gap: 12px; align-items: end;">
                    <div class="md3-text-field md3-text-field-outlined" style="flex: 1;">
                        <input type="number" class="md3-text-field-input" id="min-score" value="60" min="0" max="100" placeholder=" ">
                        <label class="md3-text-field-label">最低分数</label>
                    </div>
                    <button type="submit" class="md3-button md3-button-filled md3-button-large">
                        <i class="material-icons">search</i> 开始扫描
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Material Design 3 扫描结果区域 -->
    <div class="md3-card md3-card-elevated md3-animate-fade-in">
        <div class="md3-card-header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                    <h3 class="md3-card-title">
                        <i class="material-icons">list_alt</i> 扫描结果
                    </h3>
                    <p class="md3-card-subtitle">高评分投资机会筛选结果</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="md3-badge md3-badge-primary" id="result-count">0</span>
                    <button class="md3-button md3-button-outlined md3-button-small" id="export-btn" style="display: none;">
                        <i class="material-icons">download</i> 导出结果
                    </button>
                </div>
            </div>
        </div>
        <div class="md3-card-body">
            <!-- Enhanced Material Design 3 Loading Panel -->
            <div id="scan-loading" style="display: none; text-align: center; padding: 64px 32px;">
                <div class="md3-progress-indicator" style="margin-bottom: 24px;"></div>
                <p id="scan-message" style="color: var(--md-sys-color-on-surface); font-family: var(--md-sys-typescale-body-large-font); font-size: var(--md-sys-typescale-body-large-size); margin: 0 0 16px 0;">正在扫描市场，请稍候...</p>
                <div style="width: 100%; height: 8px; background-color: var(--md-sys-color-surface-container-highest); border-radius: 4px; margin: 24px 0; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); border-radius: 4px; animation: progress-animation 2s ease-in-out infinite;"></div>
                </div>
                <button id="cancel-scan-btn" class="md3-button md3-button-outlined">
                    <i class="material-icons">close</i> 取消扫描
                </button>
            </div>

            <!-- Enhanced Material Design 3 Error Retry Panel -->
            <div id="scan-error-retry" style="display: none; text-align: center; padding: 32px;">
                <button id="scan-retry-button" class="md3-button md3-button-filled">
                    <i class="material-icons">refresh</i> 重试扫描
                </button>
                <p style="color: var(--md-sys-color-on-surface-variant); font-family: var(--md-sys-typescale-body-medium-font); font-size: var(--md-sys-typescale-body-medium-size); margin: 16px 0 0 0;">
                    系统繁忙，请稍后重试
                </p>
            </div>

            <!-- Enhanced Material Design 3 Results Table -->
            <div id="scan-results" style="padding: 0;">
                <div style="overflow-x: auto;">
                    <table class="md3-data-table">
                        <thead>
                            <tr>
                                <th>代码</th>
                                <th>名称</th>
                                <th>行业</th>
                                <th>得分</th>
                                <th>价格</th>
                                <th>涨跌幅</th>
                                <th>RSI</th>
                                <th>MA趋势</th>
                                <th>成交量</th>
                                <th>建议</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="results-table">
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 48px; color: var(--md-sys-color-on-surface-variant);">暂无数据，请开始扫描</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes progress-animation {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(0%); }
    100% { transform: translateX(100%); }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // ===================================================================
    // 1. 文档就绪和事件绑定
    // ===================================================================
    $(document).ready(function() {
        // 表单提交事件
        $('#scan-form').submit(function(e) {
            e.preventDefault();
            let stockList = [];
            const indexCode = $('#index-selector').val();
            const industry = $('#industry-selector').val();
            const customStocks = $('#custom-stocks').val().trim();

            if (indexCode) {
                fetchIndexStocks(indexCode);
            } else if (industry) {
                fetchIndustryStocks(industry);
            } else if (customStocks) {
                stockList = customStocks.split(',').map(s => s.trim());
                scanMarket(stockList);
            } else {
                showError('请至少选择一种方式获取股票列表');
            }
        });

        // 联动选择
        $('#index-selector').change(() => { $('#industry-selector').val(''); });
        $('#industry-selector').change(() => { $('#index-selector').val(''); });

        // 导出按钮
        $('#export-btn').click(() => exportToCSV());
        
        // 取消和重试按钮
        $('#cancel-scan-btn').click(() => {
            if (window.currentTaskId) {
                cancelScan(window.currentTaskId);
            }
        });

        $('#scan-retry-button').click(() => {
            if (window.lastScanList) {
                scanMarket(window.lastScanList);
            }
        });
    });

    // ===================================================================
    // 2. API 调用与逻辑处理函数
    // ===================================================================
    
    // 获取指数成分股
    function fetchIndexStocks(indexCode) {
        setLoadingState(true, '正在获取指数成分股...');
        $.ajax({
            url: `/api/index_stocks?index_code=${indexCode}`,
            success: (response) => handleStockListResponse(response.stock_list, '指数'),
            error: (err) => handleFetchError(err, '指数')
        });
    }

    // 获取行业成分股
    function fetchIndustryStocks(industry) {
        setLoadingState(true, '正在获取行业成分股...');
        $.ajax({
            url: `/api/industry_stocks?industry=${encodeURIComponent(industry)}`,
            success: (response) => handleStockListResponse(response.stock_list, '行业'),
            error: (err) => handleFetchError(err, '行业')
        });
    }

    function handleStockListResponse(stockList, type) {
        if (stockList && stockList.length > 0) {
            window.lastScanList = stockList;
            scanMarket(stockList);
        } else {
            setLoadingState(false);
            showError(`获取${type}成分股失败，或列表为空`);
        }
    }

    function handleFetchError(error, type) {
        setLoadingState(false);
        showError(`获取${type}成分股失败: ` + (error.responseJSON ? error.responseJSON.error : error.statusText));
    }

    // 扫描市场
    function scanMarket(stockList) {
        setLoadingState(true, `正在准备扫描 ${stockList.length} 只股票...`);
        const minScore = parseInt($('#min-score').val() || 60);

        $.ajax({
            url: '/api/start_market_scan',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ stock_list: stockList, min_score: minScore, market_type: 'A' }),
            success: (response) => {
                if (response.task_id) {
                    window.currentTaskId = response.task_id;
                    pollScanStatus(response.task_id);
                } else {
                    handleScanError(null, '启动扫描任务失败');
                }
            },
            error: (xhr) => handleScanError(xhr, '启动扫描任务失败')
        });
    }

    // 轮询扫描状态
    function pollScanStatus(taskId) {
        let elapsedTime = 0;
        const pollInterval = setInterval(() => {
            $.ajax({
                url: `/api/scan_status/${taskId}`,
                success: (response) => {
                    elapsedTime += 2; // 轮询间隔为2秒
                    if (response.status === 'completed') {
                        clearInterval(pollInterval);
                        window.currentTaskId = null;
                        renderResults(response.result || []);
                        setLoadingState(false);
                    } else if (response.status === 'failed') {
                        clearInterval(pollInterval);
                        window.currentTaskId = null;
                        handleScanError(null, response.error || '扫描任务失败');
                    } else {
                        const progress = response.progress || 0;
                        const total = response.total || 0;
                        const processed = Math.round(total * progress / 100);
                        $('#scan-message').html(`正在扫描市场...<br>进度: ${progress}% (${processed}/${total})<br>耗时: ${elapsedTime}秒`);
                    }
                },
                error: () => { /* 错误时继续轮询，不做特殊处理 */ }
            });
        }, 2000);
        window.currentPollInterval = pollInterval; // 保存轮询ID以便取消
    }

    // 取消扫描
    function cancelScan(taskId) {
        if(window.currentPollInterval) clearInterval(window.currentPollInterval);
        window.currentTaskId = null;
        $.post(`/api/cancel_scan/${taskId}`);
        setLoadingState(false, '扫描已取消');
        $('#scan-error-retry').show();
        showError('扫描任务已取消');
    }
    
    function handleScanError(xhr, defaultMessage) {
        setLoadingState(false);
        let errorMsg = defaultMessage;
        if (xhr && xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg += ': ' + xhr.responseJSON.error;
        }
        showError(errorMsg);
        $('#scan-error-retry').show();
    }
    
    // ===================================================================
    // 3. UI 渲染与辅助函数
    // ===================================================================

    function setLoadingState(isLoading, message = '') {
        if (isLoading) {
            $('#scan-loading').show();
            $('#scan-results').hide();
            $('#scan-error-retry').hide();
            $('#scan-message').html(message);
        } else {
            $('#scan-loading').hide();
            $('#scan-results').show();
        }
    }
    
    // **这是关键的渲染函数，现在它包含了正确的辅助函数调用**
    function renderResults(results) {
        if (!results || results.length === 0) {
            $('#results-table').html('<tr><td colspan="11" style="text-align: center; padding: 48px;">未找到符合条件的股票</td></tr>');
            $('#result-count').text('0');
            $('#export-btn').hide();
            return;
        }

        let html = '';
        results.forEach(result => {
            const scoreClass = getMD3ScoreColorClass(result.score);
            const maTrendClass = getMD3TrendColorClass(result.ma_trend);
            const maTrendIcon = getTrendIcon(result.ma_trend);
            const priceChangeClass = result.price_change >= 0 ? 'md3-text-bull' : 'md3-text-bear';
            const priceChangeIcon = result.price_change >= 0 ? '<i class="material-icons">arrow_upward</i>' : '<i class="material-icons">arrow_downward</i>';

            html += `
                <tr>
                    <td>${result.stock_code}</td>
                    <td>${result.stock_name || '未知'}</td>
                    <td>${result.industry || '-'}</td>
                    <td><span class="md3-badge ${scoreClass}">${result.score}</span></td>
                    <td>${formatNumber(result.price)}</td>
                    <td class="${priceChangeClass}">${priceChangeIcon} ${formatPercent(result.price_change)}</td>
                    <td>${formatNumber(result.rsi)}</td>
                    <td class="${maTrendClass}">${maTrendIcon}</td>
                    <td>${result.volume_status}</td>
                    <td>${result.recommendation}</td>
                    <td>
                        <a href="/stock_detail/${result.stock_code}" class="md3-button md3-button-text">
                            详情
                        </a>
                    </td>
                </tr>
            `;
        });

        $('#results-table').html(html);
        $('#result-count').text(results.length);
        $('#export-btn').show();
    }
    
    // **这里是缺失的辅助函数定义**
    function getMD3ScoreColorClass(score) {
        if (score >= 80) return 'md3-badge-success';
        if (score >= 60) return 'md3-badge-primary';
        if (score >= 40) return 'md3-badge-warning';
        return 'md3-badge-error';
    }

    function getMD3TrendColorClass(trend) {
        if (trend === 'UP') return 'md3-text-bull';
        if (trend === 'DOWN') return 'md3-text-bear';
        return '';
    }

    function getTrendIcon(trend) {
        if (trend === 'UP') return 'trending_up';
        if (trend === 'DOWN') return 'trending_down';
        return 'trending_flat';
    }

    function formatNumber(num) {
        return (typeof num === 'number') ? num.toFixed(2) : '-';
    }

    function formatPercent(num) {
        return (typeof num === 'number') ? num.toFixed(2) + '%' : '-';
    }

    function showError(message) {
        const alertId = `alert-${Date.now()}`;
        const alertHtml = `
            <div id="${alertId}" class="md3-card md3-card-filled" style="background-color: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); margin-bottom: 16px; padding: 16px; display: flex; align-items: center; gap: 12px; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease;">
                <i class="material-icons">error</i>
                <span>${message}</span>
            </div>
        `;
        $('#alerts-container').prepend(alertHtml);
        setTimeout(() => $(`#${alertId}`).css({ opacity: 1, transform: 'translateY(0)' }), 10);
        setTimeout(() => $(`#${alertId}`).fadeOut(500, function() { $(this).remove(); }), 5000);
    }

    function exportToCSV() {
        const table = document.querySelector('.md3-data-table');
        let csv = [];
        table.querySelectorAll('tr').forEach(tr => {
            const row = [];
            tr.querySelectorAll('td, th').forEach((cell, index) => {
                // Skip the last "操作" column
                if (index < tr.cells.length - 1) { 
                    let text = cell.innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/,/g, '，');
                    row.push(`"${text}"`); // Enclose in quotes to handle commas
                }
            });
            csv.push(row.join(','));
        });

        const csvString = '\uFEFF' + csv.join('\n'); // Add BOM for Excel compatibility
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = '市场扫描结果_' + new Date().toISOString().slice(0, 10) + '.csv';
        link.click();
    }
</script>
{% endblock %}